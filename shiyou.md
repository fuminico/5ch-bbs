# 匿名掲示板Webサイト（5ch風）機能要件仕様書

## 1. 概要

* 対象：会員登録無し・完全匿名で利用できる掲示板サイト
* 構造：掲示板（板）＞スレッド＞レス（投稿）
* 目的：匿名での情報交換、雑談、議論
* 想定端末：PC/スマホのモダンブラウザ

## 2. 用語定義

* 板：特定テーマの投稿集合。
* スレッド：板内の話題単位。
* レス：スレッドへの個別投稿。
* 日替わりID：スレッド内で同一利用者を区別する簡易ID（IP/UA/日付を元にハッシュ、24hで更新）。
* トリップ：任意の秘密鍵から生成される固定識別子（例：名前欄に`名前#鍵`）。
* sage：スレを板一覧上位に上げない投稿属性。

## 3. 主要ユースケース

1. 板一覧を閲覧する
2. 板を選択し、スレ一覧を閲覧・ソート・検索する
3. スレ詳細を閲覧し、レスを読む・検索する
4. 新規スレを立てる（任意でテンプレあり／sage初期値設定）
5. レスを投稿する（引用・画像添付・sage選択・トリップ）
6. 不適切投稿を通報する
7. NG機能（自分用：キーワード/ID/トリップ/発言者）
8. モデレーション（管理者/モデレーター）
9. スレのアーカイブ閲覧

## 4. 機能要件

### 4.1 ナビゲーション／情報設計

* 板一覧ページ

  * 表示：板名、説明、スレ数、直近更新時刻、勢い（posts/hour）
  * ソート：デフォルト=更新順／他=勢い順・スレ数順・名前順
  * 検索：板名・説明のフリーワード
* スレ一覧（板内）

  * 表示：スレタイトル、作成者（匿名）、レス数、最終更新、勢い
  * フィルタ：キーワード・タグ（板が許可する場合）
  * ソート：更新順（デフォ）、勢い順、新着順、レス数順
  * ページング（無限スクロール可）
* スレ詳細

  * レスの時系列表示、レス番号、名前/トリップ、日替わりID、時刻、本文、画像サムネ、引用`>>n`リンク、外部URL自動リンク
  * レス検索（全文/発言者ID/トリップ/本文キーワード）
  * 表示設定：1ページあたり件数、古い順/新しい順、AA等幅フォント切替
  * NG表示：自分用NG対象の折りたたみ/非表示
  * オートリロード（N秒間隔、停止可）
* パンくず：トップ＞板＞スレ

### 4.2 投稿／編集

* 新規スレ作成

  * 入力：タイトル（必須）、本文（必須）、名前（任意、デフォ「名無し」）、メール欄（sage指定可）、画像（任意・複数可）、タグ（板設定で許可時）
  * 検証：タイトル/本文の最小文字数、NGワードチェック、連投規制、CAPTCHA
  * 成功時：スレ作成・板一覧の上位に反映（sageの場合は上げない）
* レス投稿

  * 入力：本文（必須）、名前（任意）、メール欄（sage/空）、画像添付（任意）、アンカー支援（選択したレスに`>>n`自動挿入）、プレビュー
  * バリデーション：NGワード、URL数上限、画像サイズ/拡張子、連投規制、CAPTCHA
  * 失敗時エラー表示（原因別メッセージ）
  * 成功時：レス番号採番・日替わりID付与
* 編集/削除

  * 原則：匿名性担保のため投稿者自身による編集は不可
  * 例外：投稿直後X分のみ「取り消し」ボタンで完全削除（板ポリシー設定）
  * 管理側：モデレーターが削除/編集（理由記録・透明性ログ）

### 4.3 表示機能・書式

* 書式：引用`>`、AA保持（等幅/折返し切替）、簡易マークアップ（URL自動リンク、改行保持）
* メタ：レス固有リンク、コピー用短縮リンク
* 画像：サムネ表示→クリックでモーダル原寸、EXIF除去
* 外部メディア：URLのOGPプレビュー（ドメイン許可リスト式）

### 4.4 掲示板ルール・規制

* レート制限：IP/端末指紋/日替わりID単位で投稿間隔制限（例：同一スレ30秒、全体15秒）
* 連投/コピペ検知：同一本文の連投をブロック（閾値設定）
* NGワード/禁止URLドメイン（板/全体で管理）
* 添付制限：拡張子（jpg/png/gif/webp）、最大サイズ、1投稿あたり枚数上限
* CAPTCHA：初回/勢い急上昇時/通報多数スレで強制
* 国別/ASN/VPNブロック（任意・板ポリシー）
* スレ立て規制：板ごとの新規作成間隔制限、同一IP連続立て禁止

### 4.5 通報・モデレーション

* ユーザー通報：各レス/スレに「通報」

  * 入力：理由（リスト＋任意記述）
  * スコアリング：通報数/重み/通報者信頼度
  * 自動アクション：閾値到達で一時非表示（ソフトブロック）
* 管理画面（モデレーター/管理者）

  * 通報キュー、保留/却下/削除/アーカイブ、IP/UA/投稿履歴参照、部分編集（個人情報マスキング）、スレ止め（クローズ）、強制sage、凍結
  * NGワード/禁止ドメイン管理、レート制限設定、板作成/並び替え
  * 監査ログ（だれが・いつ・何を・なぜ）
* 透明性レポート（公開用）

  * 月次：削除件数、理由内訳、通報統計、運用ポリシー更新履歴

### 4.6 検索

* 全体検索：スレタイトル・本文、板フィルタ、期間指定、並び替え（新着/関連順/勢い）
* 板内検索・スレ内検索：キーワード・発言者ID/トリップ

### 4.7 スレ運用

* sage：メール欄`sage`で上位表示抑制
* テンプレ：スレ1にテンプレ固定（編集は管理のみ）
* Partスレ支援：既存スレからタイトル・テンプレ継承して新規作成
* アーカイブ：一定期間無更新で自動ロック、静的化表示

### 4.8 個人向け機能（ログイン不要の範囲）

* 自分用設定の保存：ローカルストレージ/Cookie

  * NG設定、表示件数、テーマ（ライト/ダーク）、等幅フォント、オートリロード間隔
* お気に入り：板/スレをローカル保存、更新バッジ表示
* 通知：ブラウザ通知（許可時）でお気に入りスレ更新

### 4.9 国際化/アクセシビリティ/表示

* 多言語対応（初期は日本語、i18n対応）
* キーボード操作、スクリーンリーダー対応、コントラスト確保
* レイアウト：レスポンシブ、長文折りたたみ、巨大AA対策（横スクロール）

### 4.10 運用・法令順守（機能側の取り扱い）

* 投稿ログ：匿名掲示だが、違法対応のためIP/UA/時刻/板・スレ・レスIDを法定/ポリシー範囲で保有
* 削除依頼窓口：専用フォーム、受理～対応結果の通知（掲示板上での公開可）
* 利用規約/ガイドラインの掲示、同意チェック（初回閲覧時）

## 5. 管理系機能（詳細）

* 権限ロール：管理者 / モデレーター / ビューア
* ダッシュボード：アクセス・勢い、通報量、エラーレート
* 板管理：作成/名称/説明/表示順/ローカルルール/規制値
* ユーザー規制：IP/ASN/端末指紋の期間BAN、解除、理由ログ
* バナー/告知：全体告知・板別告知（開始/終了、固定表示）
* バックアップ/リストア：スレ・板単位のエクスポート/インポート（管理限定）

## 6. 外部連携（任意）

* 読み専API（公開読み取り専用）：

  * エンドポイント例：

    * `GET /api/boards`（板一覧）
    * `GET /api/boards/{id}/threads`
    * `GET /api/threads/{id}`（レス一覧・ページング）
  * レート制限、CORS方針
* Webhook（任意）：通報発生、勢い急上昇通知

## 7. データ項目（抜粋）

* 板：id, name, description, rules, order, created\_at, updated\_at
* スレ：id, board\_id, title, created\_at, updated\_at, is\_archived, is\_locked, tags\[]
* レス：id, thread\_id, no, name, trip, day\_id, email, body, has\_media, created\_at, ip\_hash, ua\_hash, flags{saged,deleted,masked}
* 通報：id, target\_type(thread|post), target\_id, reason\_code, note, score, status, created\_at, handled\_by

## 8. バリデーション・閾値（初期案）

* タイトル：1–80文字／本文：1–10,000文字
* 画像：～5MB/枚、～3枚/投稿、拡張子：jpg/png/gif/webp
* URL上限：本文内最大10本
* 連投：同一スレ30秒/同一端末、全体15秒/端末
* 同一本文投稿：直近N分で拒否（N=10分など）
* 通報自動非表示：スコア≥Xで暫定隠し（Xは通報者信頼度で可変）

## 9. 例外・エラー設計（例）

* 429 Too Many Requests：レート超過
* 400 Bad Request：NGワード/禁止ドメイン/本文不足
* 415 Unsupported Media Type：添付拡張子不正
* UI上は原因別に明示（再投稿可能時刻の表示など）

## 10. 監査・透明性

* 管理操作ログ：時刻・操作者・対象・理由
* 月次透明性報告の自動生成（公開ページへ）

---

必要なら、この仕様をもとに「画面ワイヤー」「API詳細（リクエスト/レスポンス例）」「モデレーション運用手順書」もセットで作ります。
